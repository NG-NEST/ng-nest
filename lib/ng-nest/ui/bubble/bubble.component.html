<div class="x-bubble" [ngClass]="classMap()">
  @if (!!avatar()) {
    <div class="x-bubble-avatar" [class.x-bubble-avatar-hidden]="avatar()?.hidden">
      <x-avatar
        [icon]="avatar()?.icon!"
        [label]="avatar()?.label!"
        [src]="avatar()?.src!"
        [size]="avatar()?.size ?? sizeSignal()"
        [gap]="avatar()?.gap ?? '0.25rem'"
        [fit]="avatar()?.fit ?? 'cover'"
        [backgroundColor]="avatar()?.backgroundColor ?? '#999999'"
        [color]="avatar()?.color ?? '#FFFFFF'"
        [shape]="avatar()?.shape ?? 'circle'"
      ></x-avatar>
    </div>
  }
  <div #wrapperRef class="x-bubble-wrapper">
    @if (loading()) {
      <div class="x-bubble-content" [x-loading]="true" [size]="'small'" inline></div>
    } @else {
      @if (header()) {
        <div class="x-bubble-header">
          <ng-container *xOutlet="header()">{{ header() }}</ng-container>
        </div>
      }

      @if (isReasoningString()) {
        <div class="x-bubble-reasoning">
          <ng-container *xOutlet="reasoningHeaderTpl"></ng-container>
          @if (reasoningToggle()) {
            <div class="x-bubble-reasoning-content" #reasoningContentRef [innerHTML]="reasoningRenderedContent()"></div>
          }
        </div>
      } @else if (isReasoningTemplate()) {
        <div class="x-bubble-reasoning">
          <ng-container *xOutlet="reasoningHeaderTpl"></ng-container>
          @if (reasoningToggle()) {
            <div class="x-bubble-reasoning-content" #reasoningContentRef>
              <ng-container *xOutlet="reasoningContent()"></ng-container>
            </div>
          }
        </div>
      }

      <ng-template #reasoningHeaderTpl>
        <div class="x-bubble-reasoning-header" (click)="onReasoningToggle()">
          <x-icon
            class="x-bubble-reasoning-toggle"
            [type]="reasoningToggle() ? 'fto-chevron-down' : 'fto-chevron-right'"
          ></x-icon>
          <span>{{ reasoningTitle() }}</span>
        </div>
      </ng-template>

      @if (isString()) {
        <div class="x-bubble-content" #contentRef [innerHTML]="renderedContent()"></div>
      } @else if (isTemplate()) {
        <div class="x-bubble-content" #contentRef>
          <ng-container *xOutlet="content()"></ng-container>
        </div>
      }

      @if (footer()) {
        <div class="x-bubble-footer">
          <ng-container *xOutlet="footer()">{{ footer() }}</ng-container>
        </div>
      }
    }
  </div>
</div>
